<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AnalysisService テスト</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f7f7fa; margin: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 32px; }
        h2 { font-size: 1.3rem; margin-bottom: 1.2rem; }
        form { display: flex; flex-direction: column; gap: 1.2em; }
        .btn { background: #1976d2; color: #fff; border: none; padding: 0.5em 1.5em; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #125ea2; }
        .error { color: #c00; margin-bottom: 1em; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 2em; }
        .result-table th, .result-table td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        .result-table th { background: #f0f0f8; }
    </style>
</head>
<body>
<div class="container">
    <h2 th:text="#{analysis.test.title}">AnalysisService テスト</h2>
    <form id="analysisForm" th:action="@{'/admin/analysis-test'}" method="post" enctype="multipart/form-data">
        <div th:if="${error}" class="error" th:text="${error}"></div>
        <div th:if="${message}" class="error" th:text="${message}"></div>
        <div>
            <label for="analysisType" th:text="#{analysis.test.analysisType.label}">解析種別を選択:</label>
            <select id="analysisType" name="analysisName" required style="width:auto; min-width:180px;" oninput="adjustSelectWidth(this)">
                <!-- displayNameを値として送信 -->
                <option th:each="type : ${analysisTypes}" th:value="${type.displayName}" th:text="${type.displayName}"></option>
            </select>
            <script>
            function adjustSelectWidth(select) {
                var tmp = document.createElement('span');
                tmp.style.visibility = 'hidden';
                tmp.style.position = 'fixed';
                tmp.style.font = window.getComputedStyle(select).font;
                var max = 0;
                for (var i = 0; i < select.options.length; i++) {
                    tmp.textContent = select.options[i].text;
                    document.body.appendChild(tmp);
                    max = Math.max(max, tmp.offsetWidth);
                    document.body.removeChild(tmp);
                }
                select.style.width = (max + 40) + 'px'; // 余白分加算
            }
            window.addEventListener('DOMContentLoaded', function() {
                var sel = document.getElementById('analysisType');
                adjustSelectWidth(sel);
                sel.addEventListener('change', function() { adjustSelectWidth(sel); });
            });
            </script>
        </div>
        <div>
            <label for="imageFile" th:text="#{analysis.test.imageFile.label}">画像ファイルを選択:</label>
            <input type="file" id="imageFile" name="imageFile" accept="image/*" required />
        </div>
        <div id="embedDataFields" style="display:none;">
            <label for="embedDataType">埋め込みデータ種別:</label>
            <select id="embedDataType" name="embedDataType">
                <option value="TEXT">テキスト</option>
                <option value="IMAGE">画像（ファイルアップロード）</option>
            </select>
            <div id="embedTextAreaWrap">
                <label for="embedData">埋め込みデータ（テキスト）:</label>
                <textarea id="embedData" name="embedData" rows="3" style="width:100%;"></textarea>
            </div>
            <div id="embedImageInputWrap" style="display:none;">
                <label for="embedImageFile">埋め込み画像ファイル:</label>
                <input type="file" id="embedImageFile" name="embedImageFile" accept="image/*" />
            </div>
            <button type="submit" class="btn" id="btnDivEmbed">画像分割＋埋め込み</button>
        </div>
        <div id="restoreFields" style="display:none;">
            <label for="dividedImages">分割画像ファイル（複数選択可）:</label>
            <input type="file" id="dividedImages" name="dividedImages" multiple accept="image/*" />
            <button type="submit" class="btn" id="btnRestore">分割画像から復号</button>
        </div>
        <input type="hidden" name="accessKey" th:value="${accessKey}" />
        <button type="submit" class="btn" th:text="#{analysis.test.run.button}">解析実行</button>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var sel = document.getElementById('analysisType');
            var embedFields = document.getElementById('embedDataFields');
            var restoreFields = document.getElementById('restoreFields');
            var form = document.getElementById('analysisForm');
            var embedDataTypeSel = document.getElementById('embedDataType');
            var embedTextAreaWrap = document.getElementById('embedTextAreaWrap');
            var embedImageInputWrap = document.getElementById('embedImageInputWrap');
            function updateForm() {
                var val = sel.value || '';
                // 「分割」または division を含む場合に分割UIを表示
                if (val.includes('分割') || val.toLowerCase().includes('division')) {
                    embedFields.style.display = '';
                    restoreFields.style.display = '';
                } else {
                    embedFields.style.display = 'none';
                    restoreFields.style.display = 'none';
                    form.action = '/admin/analysis-test';
                }
            }
            sel.addEventListener('change', updateForm);
            updateForm();
            // 埋め込みデータ種別切り替え
            function updateEmbedDataType() {
                if (embedDataTypeSel.value === 'IMAGE') {
                    embedTextAreaWrap.style.display = 'none';
                    embedImageInputWrap.style.display = '';
                } else {
                    embedTextAreaWrap.style.display = '';
                    embedImageInputWrap.style.display = 'none';
                }
            }
            embedDataTypeSel.addEventListener('change', updateEmbedDataType);
            updateEmbedDataType();
            // 画像分割＋埋め込みボタン
            document.getElementById('btnDivEmbed').onclick = function(e) {
                form.action = '/admin/analysis-test/image-division';
                document.getElementById('dividedImages').removeAttribute('required');
            };
            // 分割画像から復号ボタン
            document.getElementById('btnRestore').onclick = function(e) {
                form.action = '/admin/analysis-test/image-division-restore';
                document.getElementById('dividedImages').setAttribute('required', 'required');
                document.getElementById('imageFile').removeAttribute('required');
            };
        });
        </script>
    </form>
    <div th:if="${results}">
        <h3 th:text="#{analysis.test.result.title}">解析結果</h3>
        <table class="result-table">
            <thead>
            <tr>
                <th th:text="#{analysis.test.result.preview}">プレビュー</th>
                <th th:text="#{analysis.test.result.fileName}">ファイル名</th>
                <th th:text="#{analysis.test.result.size}">サイズ(MB)</th>
                <th th:text="#{analysis.test.result.width}">幅</th>
                <th th:text="#{analysis.test.result.height}">高さ</th>
                <th th:text="#{analysis.test.result.similarity}">類似度</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${results}">
                <td><img th:src="@{'data:image/*;base64,' + ${r.imageBase64}}" style="max-width:80px; max-height:60px; border:1px solid #ccc; background:#fafaff;" th:if="${r.imageBase64 != ''}" /></td>
                <td th:text="${r.fileName}"></td>
                <td th:text="${#numbers.formatDecimal(r.fileSize / 1024.0 / 1024.0, 1, 3)}"></td>
                <td th:text="${r.width}"></td>
                <td th:text="${r.height}"></td>
                <td th:text="${#numbers.formatDecimal(r.similarity, 1, 4)}"></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div th:if="${imageBase64 != null}">
        <h4 th:text="#{analysis.test.selectedImagePreview}">選択画像プレビュー</h4>
        <div style="margin-bottom:1em;">
            <img th:src="@{'data:image/*;base64,' + ${imageBase64}}" id="preview" style="max-width:300px; max-height:200px; border:1px solid #ccc; background:#fafaff;" />
        </div>
        <div>
            <span th:text="#{analysis.test.fileName}">ファイル名: </span><span th:text="${imageFileName}"></span>
            <span style="margin-left:1em;" th:text="#{analysis.test.size}">サイズ: </span><span th:text="${imageFileSizeMB}"></span>MB
            <span style="margin-left:1em;" th:text="#{analysis.test.width}">幅: </span><span th:text="${imageWidth}"></span>
            <span style="margin-left:1em;" th:text="#{analysis.test.height}">高さ: </span><span th:text="${imageHeight}"></span>
        </div>
    </div>
    <div style="margin-top: 2.5em; text-align: right;">
        <a th:href="@{'/admin'}" class="btn" style="background: #888; margin-left: 0.5em;" th:text="#{analysis.test.backToAdmin}">管理画面トップへ戻る</a>
    </div>
</div>
</body>
</html>
